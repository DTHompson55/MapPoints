<!DOCTYPE html>
<html>
<head>
<style type="text/css">
html, body, #map-canvas {
	height: 100%;
	margin: 0;
	padding: 0;
}
</style>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.5/angular.min.js"></script>
<script type="text/javascript" src="google_key.js"></script>

<script
src="https://maps.googleapis.com/maps/api/js?key=YAIzaSyDFOmNMtv3N_6AxGyMyPXXwSglEIhjYRw"
type="text/javascript"</script>

<script type="text/javascript"
	src="https://maps.googleapis.com/maps/api/js?libraries=geometry;key=YAIzaSyDFOmNMtv3N_6AxGyMyPXXwSglEIhjYRw">	
</script>

<script type="text/javascript">
	var app = angular.module('mapHelper', []); // dependencies
</script>

<script type="text/javascript" src="mqttws31.js">
	
</script>


<script type="text/javascript">
	function initialize() {

		//        var hostname = "72.209.49.136";
		//        var hostname = "192.168.2.15";
		var hostname = "localhost";
		var map = "";
		var circle;

		var port = 8001;
		var clientid = "mapDemo_" + parseInt(Math.random() * 100, 10);
		//

		client = new Paho.MQTT.Client(hostname, Number(port), clientid);
		client.onConnectionLost = onConnectionLost;
		client.onMessageArrived = onMessageArrived;
		client.connect({
			onSuccess : onConnect
		});

		//client2 = new Paho.MQTT.Client(hostname, Number(port), clientid+"_2");
		//client2.onConnectionLost = onConnectionLost;
		//client2.onMessageArrived = onMessageArrived;
		//client2.connect({onSuccess:onConnect});

		var markerCounter = 1;
		var previousMarker;
		var markers = [];
		var previousLoc;

		var mapOptions = { // need to externalize or parameterize these
			center : {
				lat : 43.6608235,
				lng : -79.3937608
			},
			zoom : 19
		};

		map = new google.maps.Map(document.getElementById('map-canvas'),
				mapOptions);

		google.maps.event.addListener(map, 'click', function(event) {
			placeMarker(event.latLng);
		});

		function onConnect() {
			// Once a connection has been made, make a subscription and send a message.
			console.log("onConnect");
			client.subscribe("/WorldCmd");
		}
		;

		function onConnectionLost(responseObject) {
			if (responseObject.errorCode !== 0)
				console.log("onConnectionLost:" + responseObject.errorMessage);
		}
		;
		function onMessageArrived(message) {
			var payload = JSON.parse(message.payloadString);
			if (payload.id == clientid) {
				console.log("onMessageArrived:" + message.payloadString);

				if (payload.type == "circle") {
					console.log("circle");
					var center = new google.maps.LatLng(payload.lat,
							payload.lng);
					var radius = payload.distance;

					var circleOptions = {
						strokeColor : '#FF0000',
						strokeOpacity : 0.8,
						strokeWeight : 2,
						fillColor : '#FF0000',
						fillOpacity : 0.35,
						map : map,
						center : center,
						radius : radius * 609
					};

					if (circle != null) {
						circle.setMap(null);
					}
					circle = new google.maps.Circle(circleOptions);
					google.maps.event.addListener(circle, 'click', function(
							event) {
						placeMarker(event.latLng);
					});
					console.log("end of circle");
				}

				console.log("not a circle");
				if (payload.type == "warning") {
					console.log("warning");
					alert("Warning from DSI - " + payload.message);
				}

				console.log("not a warning");
				if (payload.type == "alert") {
					console.log("alert");
					alert("Alert from DSI - " + payload.message);

				}
			}
			//client.disconnect();
		}
		;

		function placeMarker(location) {
			var marker = new google.maps.Marker({
				position : location,
				title : "Marker #" + markerCounter,
				map : map
			});

			previousLoc = location;

			if (markerCounter > 5) {
				markers[markerCounter - 4].setMap(null);
			}

			markers[markerCounter] = marker;
			markerCounter += 1;
			previousMarker = marker;

			var latitude = location.lat();
			var longitude = location.lng();
			console.log(latitude + ', ' + longitude);

			// Once a connection has been made, make a subscription and send a message.
			var payload = {};
			payload.type = "marker";
			payload.id = clientid;
			payload.lat = location.lat();
			payload.lng = location.lng();
			payload.time = new Date().getTime();

			message = new Paho.MQTT.Message(JSON.stringify(payload)); // need to serialize the js object to a JSON representation
			message.destinationName = "/World";
			client.send(message);
		}
	}
	google.maps.event.addDomListener(window, 'load', initialize);
</script>
</head>
<body ng-app="mapHelper">
	<div id="map-canvas"></div>
</body>
</html>